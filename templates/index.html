<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cloud Foundry Service Tester</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .header p {
            opacity: 0.9;
            font-size: 1.1em;
        }
        
        .tabs {
            display: flex;
            background: #f5f5f5;
            border-bottom: 2px solid #ddd;
            flex-wrap: wrap;
        }
        
        .tab-button {
            padding: 15px 30px;
            background: transparent;
            border: none;
            cursor: pointer;
            font-size: 1em;
            font-weight: 500;
            color: #666;
            transition: all 0.3s;
            border-bottom: 3px solid transparent;
        }
        
        .tab-button:hover {
            background: #e9e9e9;
            color: #333;
        }
        
        .tab-button.active {
            color: #667eea;
            border-bottom-color: #667eea;
            background: white;
        }
        
        .tab-content {
            display: none;
            padding: 40px;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .service-form {
            max-width: 600px;
            margin: 0 auto;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 500;
        }
        
        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 1em;
            transition: border-color 0.3s;
        }
        
        .form-group input:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }
        
        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 6px;
            font-size: 1em;
            font-weight: 500;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            width: 100%;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .btn:active {
            transform: translateY(0);
        }
        
        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }
        
        .result {
            margin-top: 30px;
            padding: 20px;
            border-radius: 6px;
            display: none;
        }
        
        .result.success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
            display: block;
        }
        
        .result.error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
            display: block;
        }
        
        .result pre {
            background: rgba(0, 0, 0, 0.05);
            padding: 15px;
            border-radius: 4px;
            overflow-x: auto;
            margin-top: 10px;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
            margin-right: 10px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .no-services {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }
        
        .no-services h2 {
            margin-bottom: 20px;
            color: #333;
        }
        
        .resources-section {
            margin-top: 30px;
            padding-top: 30px;
            border-top: 2px solid #eee;
        }
        
        .resources-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .resources-header h3 {
            margin: 0;
            color: #333;
        }
        
        .refresh-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9em;
            transition: background 0.3s;
        }
        
        .refresh-btn:hover {
            background: #5568d3;
        }
        
        .resources-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 6px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        .resources-table th {
            background: #f5f5f5;
            padding: 12px;
            text-align: left;
            font-weight: 600;
            color: #333;
            border-bottom: 2px solid #ddd;
        }
        
        .resources-table td {
            padding: 12px;
            border-bottom: 1px solid #eee;
        }
        
        .resources-table tr:last-child td {
            border-bottom: none;
        }
        
        .resources-table tr:hover {
            background: #f9f9f9;
        }
        
        .resources-loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }
        
        .resources-error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 6px;
            margin-top: 10px;
        }
        
        .badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.85em;
            font-weight: 500;
        }
        
        .badge-primary {
            background: #667eea;
            color: white;
        }
        
        .badge-success {
            background: #28a745;
            color: white;
        }
        
        .badge-info {
            background: #17a2b8;
            color: white;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Cloud Foundry Service Tester</h1>
            <p>Test transactions to your backend services</p>
        </div>
        
        <div id="tabs-container">
            <div class="tabs" id="tabs"></div>
            <div id="tab-contents">
                <div class="no-services">
                    <h2>No Services Configured</h2>
                    <p>Please enable services in services-config.yml</p>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        const services = {{ services | tojson }};
        
        // Service-specific form fields
        const serviceForms = {
            rabbitmq: {
                queue_name: { type: 'text', label: 'Queue Name', value: 'test_queue', required: true },
                message: { type: 'textarea', label: 'Message', value: 'Hello from RabbitMQ!', required: true }
            },
            valkey: {
                key: { type: 'text', label: 'Key', value: 'test_key', required: true },
                value: { type: 'textarea', label: 'Value', value: 'Hello from Valkey!', required: true }
            },
            mysql: {
                table_name: { type: 'text', label: 'Table Name', value: 'test_table', required: true },
                value: { type: 'textarea', label: 'Test Value', value: 'Hello from MySQL!', required: true }
            },
            postgres: {
                table_name: { type: 'text', label: 'Table Name', value: 'test_table', required: true },
                value: { type: 'textarea', label: 'Test Value', value: 'Hello from PostgreSQL!', required: true }
            }
        };
        
        // Helper function to escape HTML
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // Initialize tabs
        function initializeTabs() {
            const tabsContainer = document.getElementById('tabs');
            const tabContentsContainer = document.getElementById('tab-contents');
            
            if (Object.keys(services).length === 0) {
                return;
            }
            
            tabsContainer.innerHTML = '';
            tabContentsContainer.innerHTML = '';
            
            let firstTab = true;
            
            for (const [serviceId, service] of Object.entries(services)) {
                if (!service.enabled) continue;
                
                // Create tab button
                const tabButton = document.createElement('button');
                tabButton.className = `tab-button ${firstTab ? 'active' : ''}`;
                tabButton.textContent = service.display_name;
                tabButton.onclick = (e) => switchTab(serviceId, e);
                tabsContainer.appendChild(tabButton);
                
                // Create tab content
                const tabContent = document.createElement('div');
                tabContent.className = `tab-content ${firstTab ? 'active' : ''}`;
                tabContent.id = `tab-${serviceId}`;
                tabContent.innerHTML = createServiceForm(serviceId, service.display_name);
                tabContentsContainer.appendChild(tabContent);
                
                // Load resources when tab becomes active
                if (firstTab) {
                    setTimeout(() => loadResources(serviceId), 100);
                }
                
                firstTab = false;
            }
        }
        
        function switchTab(serviceId, event) {
            // Update tab buttons
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            if (event && event.target) {
                event.target.classList.add('active');
            } else {
                // Find the button for this service
                document.querySelectorAll('.tab-button').forEach(btn => {
                    if (btn.textContent === services[serviceId].display_name) {
                        btn.classList.add('active');
                    }
                });
            }
            
            // Update tab contents
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            const activeTab = document.getElementById(`tab-${serviceId}`);
            activeTab.classList.add('active');
            
            // Load resources for the active tab
            const resourcesDiv = document.getElementById(`resources-${serviceId}`);
            if (resourcesDiv && resourcesDiv.innerHTML.includes('Loading...')) {
                loadResources(serviceId);
            }
        }
        
        function createServiceForm(serviceId, displayName) {
            const formFields = serviceForms[serviceId] || {};
            
            let formHTML = `
                <div class="service-form">
                    <h2>${displayName} Transaction Test</h2>
                    <form id="form-${serviceId}" onsubmit="testService('${serviceId}', event)">
            `;
            
            for (const [fieldName, fieldConfig] of Object.entries(formFields)) {
                formHTML += `
                    <div class="form-group">
                        <label for="${serviceId}-${fieldName}">${fieldConfig.label}</label>
                        <${fieldConfig.type} 
                            id="${serviceId}-${fieldName}" 
                            name="${fieldName}" 
                            value="${fieldConfig.value}"
                            ${fieldConfig.required ? 'required' : ''}
                            ${fieldConfig.type === 'textarea' ? `>${fieldConfig.value}</textarea>` : '>'}
                        ${fieldConfig.type !== 'textarea' ? `</${fieldConfig.type}>` : ''}
                    </div>
                `;
            }
            
            formHTML += `
                        <button type="submit" class="btn" id="btn-${serviceId}">Test ${displayName}</button>
                    </form>
                    <div id="result-${serviceId}" class="result"></div>
                    
                    <div class="resources-section">
                        <div class="resources-header">
                            <h3>${getResourceTitle(serviceId)}</h3>
                            <button class="refresh-btn" onclick="refreshCurrentView('${serviceId}')">Refresh</button>
                        </div>
                        <div id="resources-${serviceId}">
                            <div class="resources-loading">Loading...</div>
                        </div>
                    </div>
                </div>
            `;
            
            return formHTML;
        }
        
        function getResourceTitle(serviceId) {
            const titles = {
                'mysql': 'MySQL Tables',
                'postgres': 'PostgreSQL Tables',
                'rabbitmq': 'RabbitMQ Queues',
                'valkey': 'Valkey Cache Keys'
            };
            return titles[serviceId] || 'Resources';
        }
        
        async function loadResources(serviceId) {
            const resourcesDiv = document.getElementById(`resources-${serviceId}`);
            resourcesDiv.innerHTML = '<div class="resources-loading">Loading...</div>';
            
            try {
                let url = `/api/list/${serviceId}`;
                
                // For MySQL/PostgreSQL, first get table list, then auto-load first table
                if (serviceId === 'mysql' || serviceId === 'postgres') {
                    const response = await fetch(url);
                    const result = await response.json();
                    
                    if (response.ok && result.success) {
                        // If we have tables, automatically load the first table's data
                        if (result.data.tables && result.data.tables.length > 0) {
                            loadTableData(serviceId, result.data.tables[0].name, 0);
                        } else {
                            displayResources(serviceId, result.data);
                        }
                    } else {
                        resourcesDiv.innerHTML = `
                            <div class="resources-error">
                                <strong>Error:</strong> ${result.error || 'Failed to load resources'}
                            </div>
                        `;
                    }
                } else {
                    // For other services (valkey, rabbitmq), load normally
                    if (serviceId === 'valkey') {
                        url += '?pattern=*&limit=100';
                    }
                    
                    const response = await fetch(url);
                    const result = await response.json();
                    
                    if (response.ok && result.success) {
                        displayResources(serviceId, result.data);
                    } else {
                        resourcesDiv.innerHTML = `
                            <div class="resources-error">
                                <strong>Error:</strong> ${result.error || 'Failed to load resources'}
                            </div>
                        `;
                    }
                }
            } catch (error) {
                resourcesDiv.innerHTML = `
                    <div class="resources-error">
                        <strong>Error:</strong> ${error.message}
                    </div>
                `;
            }
        }
        
        function displayResources(serviceId, data) {
            const resourcesDiv = document.getElementById(`resources-${serviceId}`);
            
            if (serviceId === 'mysql' || serviceId === 'postgres') {
                displayTables(serviceId, data, resourcesDiv);
            } else if (serviceId === 'rabbitmq') {
                displayQueues(data, resourcesDiv);
            } else if (serviceId === 'valkey') {
                displayKeys(data, resourcesDiv);
            }
        }
        
        function displayTables(serviceId, data, container) {
            // Check if this is table data or table list
            if (data.columns && data.rows !== undefined) {
                displayTableData(serviceId, data, container);
                return;
            }
            
            // If we have a table list, automatically load the first table's data
            if (data.tables && data.tables.length > 0) {
                const firstTable = data.tables[0].name;
                loadTableData(serviceId, firstTable, 0);
                return;
            }
            
            // No tables found
            container.innerHTML = '<p style="color: #666; text-align: center; padding: 20px;">No tables found in database ' + (data.database || 'N/A') + '</p>';
        }
        
        function displayTableData(serviceId, data, container) {
            // Store current table name for refresh functionality
            container.setAttribute('data-current-table', data.table);
            container.setAttribute('data-current-offset', data.offset || 0);
            
            if (!data.columns || !data.rows || data.rows.length === 0) {
                container.innerHTML = `
                    <p style="color: #666; text-align: center; padding: 20px;">
                        Table <strong>${data.table}</strong> is empty or has no data.
                    </p>
                `;
                return;
            }
            
            let html = `
                <p style="margin-bottom: 15px; color: #666;">
                    Table: <strong>${data.table}</strong> | 
                    Showing rows <strong>${data.offset + 1}</strong> - <strong>${data.offset + data.returned_rows}</strong> of <strong>${data.total_rows.toLocaleString()}</strong>
                </p>
                <div style="overflow-x: auto;">
                    <table class="resources-table">
                        <thead>
                            <tr>
            `;
            
            // Display column headers
            data.columns.forEach(col => {
                html += `<th>${col}</th>`;
            });
            
            html += `
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            // Display rows
            data.rows.forEach(row => {
                html += `<tr>`;
                data.columns.forEach(col => {
                    let value = row[col];
                    if (value === null || value === undefined) {
                        value = '<span style="color: #999; font-style: italic;">NULL</span>';
                    } else if (typeof value === 'object') {
                        value = JSON.stringify(value);
                    } else {
                        value = String(value);
                        // Truncate very long values
                        if (value.length > 100) {
                            value = value.substring(0, 100) + '...';
                        }
                        // Escape HTML
                        value = value.replace(/</g, '&lt;').replace(/>/g, '&gt;');
                    }
                    html += `<td style="font-family: monospace; font-size: 0.9em;">${value}</td>`;
                });
                html += `</tr>`;
            });
            
            html += `
                        </tbody>
                    </table>
                </div>
            `;
            
            // Pagination controls
            if (data.total_rows > data.limit) {
                const currentPage = Math.floor(data.offset / data.limit) + 1;
                const totalPages = Math.ceil(data.total_rows / data.limit);
                
                html += `
                    <div style="margin-top: 20px; display: flex; align-items: center; gap: 10px;">
                        <button class="refresh-btn" onclick="loadTableData('${serviceId}', '${data.table}', ${Math.max(0, data.offset - data.limit)})" ${data.offset === 0 ? 'disabled style="opacity: 0.5; cursor: not-allowed;"' : ''}>Previous</button>
                        <span style="color: #666;">Page ${currentPage} of ${totalPages}</span>
                        <button class="refresh-btn" onclick="loadTableData('${serviceId}', '${data.table}', ${data.offset + data.limit})" ${data.offset + data.returned_rows >= data.total_rows ? 'disabled style="opacity: 0.5; cursor: not-allowed;"' : ''}>Next</button>
                    </div>
                `;
            }
            
            container.innerHTML = html;
        }
        
        function loadTableData(serviceId, tableName, offset = 0) {
            if (!tableName) {
                // If no table name provided, first get table list and then load first table
                loadResources(serviceId);
                return;
            }
            
            const resourcesDiv = document.getElementById(`resources-${serviceId}`);
            resourcesDiv.innerHTML = '<div class="resources-loading">Loading table data...</div>';
            
            fetch(`/api/list/${serviceId}?table=${encodeURIComponent(tableName)}&limit=50&offset=${offset}`)
                .then(response => response.json())
                .then(result => {
                    if (result.success) {
                        displayResources(serviceId, result.data);
                    } else {
                        resourcesDiv.innerHTML = `
                            <div class="resources-error">
                                <strong>Error:</strong> ${result.error || 'Failed to load table data'}
                            </div>
                        `;
                    }
                })
                .catch(error => {
                    resourcesDiv.innerHTML = `
                        <div class="resources-error">
                            <strong>Error:</strong> ${error.message}
                        </div>
                    `;
                });
        }
        
        function refreshCurrentView(serviceId) {
            const resourcesDiv = document.getElementById(`resources-${serviceId}`);
            
            // Check if we're viewing table data (has data-current-table attribute)
            const currentTable = resourcesDiv.getAttribute('data-current-table');
            const currentOffset = parseInt(resourcesDiv.getAttribute('data-current-offset') || '0');
            
            if (currentTable) {
                // Refresh current table data
                loadTableData(serviceId, currentTable, currentOffset);
            } else {
                // Refresh resources (will auto-load first table)
                loadResources(serviceId);
            }
        }
        
        function displayQueues(data, container) {
            if (!data.queues || data.queues.length === 0) {
                let html = '';
                if (data.note) {
                    html = `<div style="padding: 15px; background: #fff3cd; border: 1px solid #ffc107; border-radius: 6px; margin-bottom: 15px;">
                        <strong style="color: #856404;">ℹ Note:</strong>
                        <p style="color: #856404; margin-top: 8px; margin-bottom: 0;">${data.note}</p>
                    </div>`;
                }
                html += '<p style="color: #666; text-align: center; padding: 20px;">No queues found in vhost ' + (data.vhost || '/') + '</p>';
                container.innerHTML = html;
                return;
            }
            
            // Show note if present (but don't let it prevent queue display)
            let noteHtml = '';
            if (data.note) {
                noteHtml = `<div style="padding: 15px; background: #fff3cd; border: 1px solid #ffc107; border-radius: 6px; margin-bottom: 15px;">
                    <strong style="color: #856404;">ℹ Note:</strong>
                    <p style="color: #856404; margin-top: 8px; margin-bottom: 0;">${data.note}</p>
                </div>`;
            }
            
            let html = noteHtml + `
                <p style="margin-bottom: 15px; color: #666;">
                    Virtual Host: <strong>${data.vhost || '/'}</strong> | 
                    Queues: <strong>${data.count}</strong>
                </p>
                <table class="resources-table">
                    <thead>
                        <tr>
                            <th>Queue Name</th>
                            <th>Messages</th>
                            <th>Consumers</th>
                            <th>Properties</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            data.queues.forEach(queue => {
                const badges = [];
                if (queue.durable) badges.push('<span class="badge badge-primary">Durable</span>');
                if (queue.auto_delete) badges.push('<span class="badge badge-info">Auto-delete</span>');
                
                // Build message contents display
                let messageContentsHtml = '';
                if (queue.message_contents && queue.message_contents.length > 0) {
                    messageContentsHtml = '<div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid #ddd;">';
                    messageContentsHtml += '<strong style="color: #667eea; font-size: 0.9em;">Queue Contents:</strong>';
                    queue.message_contents.forEach((msg, idx) => {
                        messageContentsHtml += `<div style="margin-top: 5px; padding: 6px; background: #f8f9fa; border-radius: 4px; font-family: monospace; font-size: 0.85em; word-wrap: break-word;">${escapeHtml(String(msg))}</div>`;
                    });
                    if (queue.messages > queue.message_contents.length) {
                        messageContentsHtml += `<div style="margin-top: 5px; color: #666; font-size: 0.85em;">... and ${queue.messages - queue.message_contents.length} more message(s)</div>`;
                    }
                    messageContentsHtml += '</div>';
                }
                
                html += `
                    <tr>
                        <td><strong>${queue.name}</strong>${messageContentsHtml}</td>
                        <td>${queue.messages.toLocaleString()}</td>
                        <td>${queue.consumers}</td>
                        <td>${badges.join(' ')}</td>
                    </tr>
                `;
            });
            
            html += `
                    </tbody>
                </table>
            `;
            
            container.innerHTML = html;
        }
        
        function displayKeys(data, container) {
            if (!data.keys || data.keys.length === 0) {
                container.innerHTML = '<p style="color: #666; text-align: center; padding: 20px;">No keys found matching pattern: ' + data.pattern + '</p>';
                return;
            }
            
            let html = `
                <p style="margin-bottom: 15px; color: #666;">
                    Pattern: <strong>${data.pattern}</strong> | 
                    Showing: <strong>${data.count}</strong>
                    ${data.total_found !== null ? '| Total: <strong>' + data.total_found + '</strong>' : ''}
                </p>
                <table class="resources-table">
                    <thead>
                        <tr>
                            <th>Key</th>
                            <th>Type</th>
                            <th>TTL</th>
                            <th>Value Preview</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            data.keys.forEach(keyInfo => {
                const ttlDisplay = keyInfo.ttl !== null && keyInfo.ttl !== undefined 
                    ? keyInfo.ttl + 's' 
                    : '<span style="color: #999;">No expiration</span>';
                
                html += `
                    <tr>
                        <td><strong>${keyInfo.key}</strong></td>
                        <td><span class="badge badge-info">${keyInfo.type}</span></td>
                        <td>${ttlDisplay}</td>
                        <td style="font-family: monospace; font-size: 0.9em; color: #666;">
                            ${keyInfo.value_preview || 'N/A'}
                        </td>
                    </tr>
                `;
            });
            
            html += `
                    </tbody>
                </table>
            `;
            
            container.innerHTML = html;
        }
        
        async function testService(serviceId, event) {
            event.preventDefault();
            
            const form = document.getElementById(`form-${serviceId}`);
            const resultDiv = document.getElementById(`result-${serviceId}`);
            const btn = document.getElementById(`btn-${serviceId}`);
            
            // Get form data
            const formData = new FormData(form);
            const data = {};
            for (const [key, value] of formData.entries()) {
                data[key] = value;
            }
            
            // Show loading state
            btn.disabled = true;
            btn.innerHTML = '<span class="loading"></span>Testing...';
            resultDiv.className = 'result';
            resultDiv.innerHTML = '';
            
            try {
                const response = await fetch(`/api/test/${serviceId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                if (response.ok && result.success) {
                    resultDiv.className = 'result success';
                    
                    // Special display format for valkey
                    if (serviceId === 'valkey' && result.data) {
                        const key = result.data.key || 'N/A';
                        const setValue = result.data.set_value || 'N/A';
                        const retrievedValue = result.data.retrieved_value || 'N/A';
                        const ttl = result.data.ttl !== undefined ? result.data.ttl : 'N/A';
                        
                        resultDiv.innerHTML = `
                            <h3>✓ Transaction Successful</h3>
                            <div style="margin-top: 15px;">
                                <div style="margin-bottom: 15px; padding: 15px; background: rgba(255, 255, 255, 0.5); border-radius: 6px;">
                                    <div style="margin-bottom: 10px;">
                                        <strong style="color: #667eea;">Key:</strong>
                                        <div style="font-family: monospace; padding: 8px; background: white; border-radius: 4px; margin-top: 5px;">${escapeHtml(String(key))}</div>
                                    </div>
                                    <div style="margin-bottom: 10px;">
                                        <strong style="color: #667eea;">Value Set:</strong>
                                        <div style="font-family: monospace; padding: 8px; background: white; border-radius: 4px; margin-top: 5px; white-space: pre-wrap; word-wrap: break-word;">${escapeHtml(String(setValue))}</div>
                                    </div>
                                    <div style="margin-bottom: 10px;">
                                        <strong style="color: #667eea;">Value Retrieved:</strong>
                                        <div style="font-family: monospace; padding: 8px; background: white; border-radius: 4px; margin-top: 5px; white-space: pre-wrap; word-wrap: break-word;">${escapeHtml(String(retrievedValue))}</div>
                                    </div>
                                    <div>
                                        <strong style="color: #667eea;">TTL:</strong>
                                        <span style="margin-left: 10px;">${ttl !== 'N/A' ? ttl + ' seconds' : 'No expiration'}</span>
                                    </div>
                                </div>
                                <details style="margin-top: 15px;">
                                    <summary style="cursor: pointer; color: #667eea; font-weight: 500;">View Full JSON Response</summary>
                                    <pre style="margin-top: 10px;">${JSON.stringify(result, null, 2)}</pre>
                                </details>
                            </div>
                        `;
                    } else if (serviceId === 'rabbitmq' && result.data) {
                        // Special display format for rabbitmq
                        const queue = result.data.queue || 'N/A';
                        const published = result.data.published || 'N/A';
                        const consumed = result.data.consumed || 'N/A';
                        
                        resultDiv.innerHTML = `
                            <h3>✓ Transaction Successful</h3>
                            <div style="margin-top: 15px;">
                                <div style="margin-bottom: 15px; padding: 15px; background: rgba(255, 255, 255, 0.5); border-radius: 6px;">
                                    <div style="margin-bottom: 10px;">
                                        <strong style="color: #667eea;">Queue Name:</strong>
                                        <div style="font-family: monospace; padding: 8px; background: white; border-radius: 4px; margin-top: 5px;">${escapeHtml(String(queue))}</div>
                                    </div>
                                    <div style="margin-bottom: 10px;">
                                        <strong style="color: #667eea;">Message Published:</strong>
                                        <div style="font-family: monospace; padding: 8px; background: white; border-radius: 4px; margin-top: 5px; white-space: pre-wrap; word-wrap: break-word;">${escapeHtml(String(published))}</div>
                                    </div>
                                    <div style="margin-bottom: 10px;">
                                        <strong style="color: #667eea;">Message Consumed:</strong>
                                        <div style="font-family: monospace; padding: 8px; background: white; border-radius: 4px; margin-top: 5px; white-space: pre-wrap; word-wrap: break-word;">${escapeHtml(String(consumed))}</div>
                                    </div>
                                    <div>
                                        <strong style="color: #667eea;">Action:</strong>
                                        <span style="margin-left: 10px;">${result.data.action || 'publish_and_consume'}</span>
                                    </div>
                                </div>
                                <details style="margin-top: 15px;">
                                    <summary style="cursor: pointer; color: #667eea; font-weight: 500;">View Full JSON Response</summary>
                                    <pre style="margin-top: 10px;">${JSON.stringify(result, null, 2)}</pre>
                                </details>
                            </div>
                        `;
                    } else if ((serviceId === 'mysql' || serviceId === 'postgres') && result.data) {
                        // Special display format for MySQL and PostgreSQL
                        const table = result.data.table || 'N/A';
                        const insertId = result.data.insert_id || 'N/A';
                        const insertedValue = result.data.inserted_value || 'N/A';
                        const retrievedRow = result.data.retrieved_row || {};
                        const retrievedId = retrievedRow.id || 'N/A';
                        const retrievedValue = retrievedRow.test_value || 'N/A';
                        const createdAt = retrievedRow.created_at || 'N/A';
                        
                        resultDiv.innerHTML = `
                            <h3>✓ Transaction Successful</h3>
                            <div style="margin-top: 15px;">
                                <div style="margin-bottom: 15px; padding: 15px; background: rgba(255, 255, 255, 0.5); border-radius: 6px;">
                                    <div style="margin-bottom: 10px;">
                                        <strong style="color: #667eea;">Table:</strong>
                                        <div style="font-family: monospace; padding: 8px; background: white; border-radius: 4px; margin-top: 5px;">${escapeHtml(String(table))}</div>
                                    </div>
                                    <div style="margin-bottom: 10px;">
                                        <strong style="color: #667eea;">Insert ID:</strong>
                                        <div style="font-family: monospace; padding: 8px; background: white; border-radius: 4px; margin-top: 5px;">${escapeHtml(String(insertId))}</div>
                                    </div>
                                    <div style="margin-bottom: 10px;">
                                        <strong style="color: #667eea;">Value Inserted:</strong>
                                        <div style="font-family: monospace; padding: 8px; background: white; border-radius: 4px; margin-top: 5px; white-space: pre-wrap; word-wrap: break-word;">${escapeHtml(String(insertedValue))}</div>
                                    </div>
                                    <div style="margin-bottom: 10px;">
                                        <strong style="color: #667eea;">Retrieved Row:</strong>
                                        <div style="margin-top: 5px; padding: 8px; background: white; border-radius: 4px;">
                                            <div style="margin-bottom: 5px;"><strong>ID:</strong> <span style="font-family: monospace;">${escapeHtml(String(retrievedId))}</span></div>
                                            <div style="margin-bottom: 5px;"><strong>Value:</strong> <span style="font-family: monospace; white-space: pre-wrap; word-wrap: break-word;">${escapeHtml(String(retrievedValue))}</span></div>
                                            <div><strong>Created At:</strong> <span style="font-family: monospace;">${escapeHtml(String(createdAt))}</span></div>
                                        </div>
                                    </div>
                                    <div>
                                        <strong style="color: #667eea;">Action:</strong>
                                        <span style="margin-left: 10px;">${result.data.action || 'insert_and_select'}</span>
                                    </div>
                                </div>
                                <details style="margin-top: 15px;">
                                    <summary style="cursor: pointer; color: #667eea; font-weight: 500;">View Full JSON Response</summary>
                                    <pre style="margin-top: 10px;">${JSON.stringify(result, null, 2)}</pre>
                                </details>
                            </div>
                        `;
                    } else {
                        // Default display for other services
                        resultDiv.innerHTML = `
                            <h3>✓ Transaction Successful</h3>
                            <pre>${JSON.stringify(result, null, 2)}</pre>
                        `;
                    }
                } else {
                    resultDiv.className = 'result error';
                    resultDiv.innerHTML = `
                        <h3>✗ Transaction Failed</h3>
                        <pre>${JSON.stringify(result, null, 2)}</pre>
                    `;
                }
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.innerHTML = `
                    <h3>✗ Error</h3>
                    <pre>${error.message}</pre>
                `;
            } finally {
                btn.disabled = false;
                btn.innerHTML = `Test ${services[serviceId].display_name}`;
            }
        }
        
        // Initialize on page load
        window.addEventListener('DOMContentLoaded', initializeTabs);
    </script>
</body>
</html>

